<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - QrFlow</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="../assets/css/qrflow.css" rel="stylesheet">
</head>
<body>
    <!-- Navbar -->
    <nav class="qrflow-navbar">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center">
                <a href="dashboard.html" class="qrflow-logo">
                    <div class="logo-icon"><i class="bi bi-qr-code"></i></div>
                    <span>QrFlow</span>
                    <span class="badge badge-danger ms-2">Admin</span>
                </a>
                
                <div class="d-flex gap-3">
                    <a href="dashboard.html" class="btn btn-sm btn-primary">
                        <i class="bi bi-speedometer2"></i> Dashboard
                    </a>
                    <a href="clubs.html" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-building"></i> Clubs
                    </a>
                    <a href="users.html" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-people"></i> Users
                    </a>
                    <a href="logs.html" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-clock-history"></i> Logs
                    </a>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" onclick="Auth.logout(); return false;">
                                <i class="bi bi-box-arrow-right"></i> Logout
                            </a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid mt-4">
        <h2 class="mb-4">
            <i class="bi bi-speedometer2"></i>
            System Overview
        </h2>

        <!-- Stats Cards -->
        <div class="row mb-4">
            <div class="col-6 col-md-3 mb-3">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <div class="stat-card-value text-primary" id="totalClubs">0</div>
                        <div class="stat-card-label">Total Clubs</div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3 mb-3">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <div class="stat-card-value text-success" id="totalUsers">0</div>
                        <div class="stat-card-label">Total Users</div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3 mb-3">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <div class="stat-card-value text-info" id="totalEvents">0</div>
                        <div class="stat-card-label">Total Events</div>
                    </div>
                </div>
            </div>
            <div class="col-6 col-md-3 mb-3">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <div class="stat-card-value text-warning" id="activeEvents">0</div>
                        <div class="stat-card-label">Active Events</div>
                    </div>
                </div>
            </div>
        </div>

<!-- Quick Actions & System Information -->
<div class="row mb-4">
    <div class="col-md-6 mb-3">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="bi bi-lightning-charge"></i>
                    Quick Actions
                </h5>
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" onclick="window.location.href='clubs.html'">
                        <i class="bi bi-plus-circle"></i> Create New Club
                    </button>
                    <button class="btn btn-secondary" onclick="window.location.href='users.html'">
                        <i class="bi bi-person-plus"></i> Create New User
                    </button>
                    <button class="btn btn-success" onclick="window.location.href='../organizer/dashboard.html'">
                        <i class="bi bi-calendar-event"></i> View All Events
                    </button>
                    <button class="btn btn-info" onclick="window.location.href='logs.html'">
                        <i class="bi bi-clock-history"></i> View Activity Logs
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-6 mb-3">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="bi bi-info-circle"></i>
                    System Information
                </h5>
                <div class="mb-2">
                    <strong>Application:</strong> QrFlow v1.0.0
                </div>
                <div class="mb-2">
                    <strong>Environment:</strong> <span class="badge badge-warning">Development</span>
                </div>
                <div class="mb-2">
                    <strong>Database:</strong> <span class="badge badge-success" id="dbStatus">Connected</span>
                </div>
                <div>
                    <strong>Last Login:</strong> <span id="lastLogin">Just now</span>
                </div>
            </div>
        </div>
    </div>
</div>


        <!-- Recent Clubs -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">
                                <i class="bi bi-building"></i>
                                Recent Clubs
                            </h5>
                            <a href="clubs.html" class="btn btn-sm btn-outline-primary">View All</a>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Club Name</th>
                                        <th>Email</th>
                                        <th class="d-none d-md-table-cell">Phone</th>
                                        <th class="text-center">Members</th>
                                        <th class="text-center">Events</th>
                                    </tr>
                                </thead>
                                <tbody id="recentClubsTable">
                                    <tr>
                                        <td colspan="5" class="text-center">
                                            <div class="spinner-border spinner-border-sm"></div>
                                            Loading...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">
                                <i class="bi bi-activity"></i>
                                Recent Activity
                            </h5>
                            <a href="logs.html" class="btn btn-sm btn-outline-primary">View All</a>
                        </div>
                        <div id="recentActivityList">
                            <div class="text-center py-3">
                                <div class="spinner-border spinner-border-sm"></div>
                                Loading activity...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../assets/js/config.js"></script>
    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/utils.js"></script>
    
    <script>
        Auth.requireAuth();
        const user = Auth.getCurrentUser();
        
        if (user.role !== 'admin') {
            Utils.showToast('Access denied - Admin only', 'error');
            setTimeout(() => window.location.href = '../organizer/dashboard.html', 2000);
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await loadDashboardStats();
            await loadRecentClubs();
            await loadRecentActivity();
            checkDatabaseStatus();
        });

        async function loadDashboardStats() {
            try {
                const clubs = await api.get('/api/admin/clubs');
                const users = await api.get('/api/admin/users');
                const events = await api.get('/api/events');

                document.getElementById('totalClubs').textContent = clubs.length;
                document.getElementById('totalUsers').textContent = users.length;
                document.getElementById('totalEvents').textContent = events.length;

                // Count active events (upcoming or ongoing)
                const now = new Date();
                const activeEvents = events.filter(e => new Date(e.date) >= now);
                document.getElementById('activeEvents').textContent = activeEvents.length;
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        async function loadRecentClubs() {
            try {
                const clubs = await api.get('/api/admin/clubs');
                const recentClubs = clubs.slice(0, 5);

                const tbody = document.getElementById('recentClubsTable');
                
                if (recentClubs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No clubs yet</td></tr>';
                    return;
                }

                tbody.innerHTML = '';
                for (const club of recentClubs) {
                    // Get members and events count
                    const users = await api.get(`/api/admin/clubs/${club.id}/users`);
                    const events = await api.get('/api/events');
                    const clubEvents = events.filter(e => e.club_id === club.id);

                    tbody.innerHTML += `
                        <tr>
                            <td><strong>${club.name}</strong></td>
                            <td>${club.email || '-'}</td>
                            <td class="d-none d-md-table-cell">${club.phone || '-'}</td>
                            <td class="text-center"><span class="badge badge-primary">${users.length}</span></td>
                            <td class="text-center"><span class="badge badge-info">${clubEvents.length}</span></td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('Failed to load clubs:', error);
                document.getElementById('recentClubsTable').innerHTML = 
                    '<tr><td colspan="5" class="text-center text-danger">Failed to load clubs</td></tr>';
            }
        }

        async function loadRecentActivity() {
            try {
                const logs = await api.get('/api/admin/logs?skip=0&limit=10');
                const container = document.getElementById('recentActivityList');

                if (logs.length === 0) {
                    container.innerHTML = '<p class="text-center text-muted py-3">No recent activity</p>';
                    return;
                }

                container.innerHTML = logs.map(log => `
                    <div class="d-flex justify-content-between align-items-start py-2 border-bottom">
                        <div>
                            <div class="fw-bold">${log.user_name || 'Unknown'}</div>
                            <small class="text-muted">${log.description}</small>
                        </div>
                        <small class="text-muted">${Utils.formatTime(log.timestamp)}</small>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load activity:', error);
                document.getElementById('recentActivityList').innerHTML = 
                    '<p class="text-center text-danger">Failed to load activity</p>';
            }
        }

        async function checkDatabaseStatus() {
            try {
                const health = await api.get('/health');
                if (health.status === 'healthy') {
                    document.getElementById('dbStatus').textContent = 'Connected';
                    document.getElementById('dbStatus').className = 'badge badge-success';
                } else {
                    document.getElementById('dbStatus').textContent = 'Issues Detected';
                    document.getElementById('dbStatus').className = 'badge badge-warning';
                }
            } catch (error) {
                document.getElementById('dbStatus').textContent = 'Disconnected';
                document.getElementById('dbStatus').className = 'badge badge-danger';
            }
        }
    </script>
</body>
</html>
